<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LegalConnect | Appointments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream: #F5F0E6;
      --taupe: #D8C4B6;
      --sage: #A3B18A;
      --slate: #3A5A40;
      --mauve: #B5838D;
      --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      color: #333;
      background-color: var(--cream);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .upcoming-appointment-popup {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 300px;
      background: rgba(245, 240, 230, 0.95);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.4);
      z-index: 99;
      transform: translateY(20px);
      opacity: 0;
      transition: var(--transition);
      pointer-events: none;
    }
    
    .upcoming-appointment-popup.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }
    
    .upcoming-appointment-popup h5 {
      font-family: 'Playfair Display', serif;
      color: var(--slate);
      margin-bottom: 15px;
      font-size: 1.2rem;
      border-bottom: 1px dashed rgba(51, 51, 51, 0.1);
      padding-bottom: 10px;
    }
    
    .upcoming-appointment-popup p {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }
    
    .upcoming-appointment-popup p strong {
      color: var(--sage);
      font-weight: 600;
      margin-right: 10px;
    }
    
    .upcoming-appointment-popup .view-btn {
      background: linear-gradient(90deg, var(--sage), #B5C99A);
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: 600;
      width: 100%;
      margin-top: 15px;
      transition: var(--transition);
    }
    
    .upcoming-appointment-popup .view-btn:hover {
      transform: translateY(-2px);
    }

    @keyframes pulseHighlight {
      0% { box-shadow: 0 0 0 0 rgba(163, 177, 138, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(163, 177, 138, 0); }
      100% { box-shadow: 0 0 0 0 rgba(163, 177, 138, 0); }
    }

    /* Decorative Background Elements */
    .bg-pattern {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(163, 177, 138, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(181, 131, 141, 0.05) 0%, transparent 20%);
      opacity: 0.6;
    }

    .floating-shapes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    .shape {
      position: absolute;
      opacity: 0.1;
      animation: float 25s infinite linear;
    }

    .shape-1 {
      width: 300px;
      height: 300px;
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
      background-color: var(--slate);
      top: 10%;
      left: 5%;
      animation-delay: 0s;
    }

    .shape-2 {
      width: 400px;
      height: 400px;
      border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
      background-color: var(--mauve);
      bottom: 10%;
      right: 5%;
      animation-delay: 5s;
    }

    .shape-3 {
      width: 200px;
      height: 200px;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      background-color: var(--sage);
      top: 60%;
      left: 30%;
      animation-delay: 10s;
    }

    @keyframes float {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(50px, 50px) rotate(5deg); }
      50% { transform: translate(0, 100px) rotate(0deg); }
      75% { transform: translate(-50px, 50px) rotate(-5deg); }
      100% { transform: translate(0, 0) rotate(0deg); }
    }

    /* Header */
    .app-header {
      padding: 30px 40px;
      margin: 40px auto;
      max-width: 1400px;
      transition: var(--transition);
      background: rgba(245, 240, 230, 0.8);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.05),
        inset 0 0 0 1px rgba(255, 255, 255, 0.8);
    }

    .app-header:hover {
      transform: translateY(-3px);
      box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.1),
        inset 0 0 0 1px rgba(255, 255, 255, 0.8);
    }

    .app-header h1 {
      font-family: 'Playfair Display', serif;
      font-weight: 600;
      font-size: 2.8rem;
      color: var(--slate);
      position: relative;
      display: inline-block;
      margin: 0;
    }

    .app-header h1:after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 0;
      width: 70px;
      height: 3px;
      background: linear-gradient(90deg, var(--sage), var(--taupe));
      border-radius: 3px;
      transition: var(--transition);
    }

    .app-header:hover h1:after {
      width: 90px;
    }

    /* Main Container */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 50px;
    }

    /* Cards Grid - Pinterest Style */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 30px;
      padding: 20px 0;
    }

    /* Appointment Card */
    .appointment-card {
      position: relative;
      padding: 25px;
      overflow: hidden;
      transition: var(--transition);
      opacity: 0;
      animation: cardEnter 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
      background: rgba(245, 240, 230, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 
        0 5px 20px rgba(0, 0, 0, 0.05),
        inset 0 0 0 1px rgba(255, 255, 255, 0.8);
    }

    @keyframes cardEnter {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .appointment-card:hover {
      transform: translateY(-10px) rotate(1deg);
      box-shadow: 
        0 15px 30px rgba(0, 0, 0, 0.1),
        inset 0 0 0 1px rgba(255, 255, 255, 0.9);
    }

    .appointment-card.expired {
      position: relative;
    }

    .appointment-card.expired:after {
      content: "EXPIRED";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      font-size: 4rem;
      font-weight: 700;
      font-family: 'Playfair Display', serif;
      color: rgba(51, 51, 51, 0.05);
      z-index: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px dashed rgba(51, 51, 51, 0.1);
      position: relative;
    }

    .card-header:after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 50px;
      height: 2px;
      background: var(--sage);
      transition: var(--transition);
    }

    .appointment-card:hover .card-header:after {
      width: 70px;
      background: var(--taupe);
    }

    .card-header strong {
      font-family: 'Playfair Display', serif;
      font-weight: 600;
      font-size: 1.5rem;
      color: var(--slate);
    }

    .card-body p {
      margin-bottom: 15px;
      display: flex;
      font-size: 0.95rem;
    }

    .card-body p strong {
      min-width: 80px;
      color: var(--sage);
      font-weight: 600;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      background: rgba(163, 177, 138, 0.2);
      color: var(--slate);
      transition: var(--transition);
      border: 1px solid rgba(163, 177, 138, 0.3);
    }

    .status-badge.pending {
      background: rgba(181, 131, 141, 0.2);
      color: var(--mauve);
      border-color: rgba(181, 131, 141, 0.3);
    }

    .status-badge.confirmed {
      background: rgba(58, 90, 64, 0.2);
      color: var(--slate);
      border-color: rgba(58, 90, 64, 0.3);
    }

    .status-badge.reschedule {
      background: rgba(216, 196, 182, 0.3);
      color: #8B5A2B;
      border-color: rgba(216, 196, 182, 0.4);
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(90deg, var(--sage), #B5C99A);
      border: none;
      color: white;
      padding: 12px 28px;
      border-radius: 12px;
      font-weight: 600;
      transition: var(--transition);
      box-shadow: 0 5px 15px rgba(163, 177, 138, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(163, 177, 138, 0.4);
      color: white;
    }

    .btn-outline {
      border: 2px solid var(--sage);
      color: var(--sage);
      font-weight: 600;
      border-radius: 12px;
      padding: 10px 22px;
      transition: var(--transition);
      background: transparent;
    }

    .btn-outline:hover {
      background: rgba(163, 177, 138, 0.1);
      color: var(--sage);
      transform: translateY(-3px);
    }

    .btn-success {
      background: linear-gradient(90deg, var(--slate), #588157);
      border: none;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(58, 90, 64, 0.3);
      transition: var(--transition);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(58, 90, 64, 0.4);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(90deg, var(--mauve), #C895A7);
      border: none;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(181, 131, 141, 0.3);
      transition: var(--transition);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(181, 131, 141, 0.4);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(90deg, var(--taupe), #E2D5C8);
      border: none;
      color: #5C4D3D;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(216, 196, 182, 0.3);
      transition: var(--transition);
    }

    .btn-warning:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(216, 196, 182, 0.4);
      color: #5C4D3D;
    }

    /* Dropdown */
    .dropdown-menu {
      border-radius: 12px;
      border: none;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      padding: 10px 0;
      min-width: 220px;
      background: rgba(245, 240, 230, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .dropdown-item {
      padding: 10px 20px;
      transition: var(--transition);
      color: #333;
      font-size: 0.95rem;
    }

    .dropdown-item:hover {
      background: rgba(163, 177, 138, 0.1);
      color: var(--slate);
    }

    /* Modals */
    .modal-content {
      border-radius: 16px;
      border: none;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      background: rgba(245, 240, 230, 0.95);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      transform: scale(0.95);
      opacity: 0;
      transition: var(--transition);
    }

    .modal.show .modal-content {
      transform: scale(1);
      opacity: 1;
    }

    .modal-header {
      border-bottom: 1px solid rgba(51, 51, 51, 0.1);
      background: rgba(245, 240, 230, 0.8);
      padding: 20px 25px;
    }

    .modal-title {
      font-family: 'Playfair Display', serif;
      font-weight: 600;
      font-size: 1.8rem;
      color: var(--slate);
    }

    .modal-body {
      padding: 25px;
    }

    .modal-body p {
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .modal-body strong {
      color: var(--sage);
      min-width: 140px;
      display: inline-block;
      font-weight: 600;
    }

    .modal-footer {
      border-top: 1px solid rgba(51, 51, 51, 0.1);
      padding: 20px 25px;
      background: rgba(245, 240, 230, 0.8);
    }

    /* Loading Animation */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(163, 177, 138, 0.2);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 60px 0;
      animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .empty-state i {
      font-size: 4rem;
      color: rgba(51, 51, 51, 0.1);
      margin-bottom: 20px;
      animation: pulse 2s infinite ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Floating Action Button */
    .fab {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--sage), var(--taupe));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      transition: var(--transition);
      z-index: 100;
      border: none;
    }

    .fab:hover {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .app-header {
        padding: 25px;
        margin: 20px auto;
      }

      .app-header h1 {
        font-size: 2.2rem;
        margin-bottom: 15px;
      }

      .cards-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Decorative Background Elements -->
  <div class="bg-pattern"></div>
  <div class="floating-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>
  
  <div class="main-container">
    <div class="app-header d-flex justify-content-between align-items-center flex-wrap">
      <h1><i class="fas fa-scale-balanced me-3"></i>My Appointments</h1>    
      <a class="btn btn-primary" href="{{ url_for('dashboard') }}">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
      </a>
    </div>

    <div class="dropdown mb-4">
      <button class="btn btn-outline dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-sort me-2"></i>Sort By
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" onclick="setSortOption('az')"><i class="fas fa-sort-alpha-down me-2"></i>A → Z</a></li>
        <li><a class="dropdown-item" href="#" onclick="setSortOption('za')"><i class="fas fa-sort-alpha-down-alt me-2"></i>Z → A</a></li>
        <li><a class="dropdown-item" href="#" onclick="setSortOption('newest')"><i class="fas fa-calendar-arrow-down me-2"></i>Newest First</a></li>
        <li><a class="dropdown-item" href="#" onclick="setSortOption('oldest')"><i class="fas fa-calendar-arrow-up me-2"></i>Oldest First</a></li>
      </ul>
    </div>    

    <div class="cards-grid" id="appointments-container">
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <div class="text-muted">Loading appointments...</div>
      </div>
    </div>
  </div>

  <!-- Reschedule Modal -->
  <div class="modal fade" id="rescheduleModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="rescheduleForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-calendar-day me-3"></i>Reschedule Appointment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <label class="form-label">New Date:</label>
              <input type="date" class="form-control" id="newDate" required>
            </div>
            <div class="mb-4">
              <label class="form-label">New Time:</label>
              <input type="time" class="form-control" id="newTime" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-warning">
              <i class="fas fa-paper-plane me-2"></i>Request Reschedule
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Appointment Info Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel"><i class="fas fa-file-contract me-3"></i>Appointment Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody"></div>
        <div class="modal-footer" id="modalFooterButtons">
          <button class="btn btn-success" id="confirmBtn">
            <i class="fas fa-check-circle me-2"></i>Confirm
          </button>
          <button class="btn btn-danger" id="deleteBtn">
            <i class="fas fa-trash-alt me-2"></i>Delete
          </button>
          <button class="btn btn-warning" id="rescheduleBtn">
            <i class="fas fa-calendar-alt me-2"></i>Reschedule
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="fab" id="quickActionBtn">
    <i class="fas fa-plus"></i>
  </button>

  <div class="upcoming-appointment-popup" id="upcomingAppointmentPopup">
    <h5><i class="fas fa-bell me-2"></i>Upcoming Appointment</h5>
    <div id="upcomingAppointmentContent"></div>
    <button class="view-btn" id="viewAppointmentBtn">
      <i class="fas fa-eye me-2"></i>View Details
    </button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "{{ firebase_api_key }}",
    authDomain: "{{ firebase_auth_domain }}",
    projectId: "{{ firebase_project_id }}",
    storageBucket: "{{ firebase_storage_bucket }}",
    messagingSenderId: "{{ firebase_messaging_sender_id }}",
    appId: "{{ firebase_app_id }}",
    databaseURL: "https://legaleagle-auth-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const lawyerName = localStorage.getItem("lawyerName");
  let rescheduleData = {};
  let upcomingAppointment = null;
  let allAppointments = [];
  
  let currentSort = "newest";
  function setSortOption(option) {
    currentSort = option;
    loadAppointments(lawyerName);
  }
  
  const availableTimeSlots = ["09:00 AM", "09:30 AM", "11:00 AM", "02:00 PM", "03:30 PM", "05:00 PM"];

  async function loadUpcomingAppointment() {
    const snapshot = await get(ref(db, 'bookings'));
    if (!snapshot.exists()) return null;

    const now = new Date();
    now.setMinutes(now.getMinutes() - 30);

    let upcoming = null;
    const allBookings = snapshot.val();

    for (const client in allBookings) {
      for (const id in allBookings[client]) {
        const appt = allBookings[client][id];
        if ((appt.lawyer_name || '').toLowerCase() === lawyerName.toLowerCase()) {
          const apptDateTime = new Date(`${appt.appointment_date} ${convertTimeTo24Hour(appt.appointment_time)}`);
          if (apptDateTime >= now && (!upcoming || apptDateTime < new Date(`${upcoming.appointment_date} ${convertTimeTo24Hour(upcoming.appointment_time)}`))) {
            upcoming = { ...appt, client_email: client, appt_id: id };
          }
        }
      }
    }
    return upcoming;
  }

  function convertTimeTo24Hour(timeStr) {
    const [time, modifier] = timeStr.split(' ');
    let [hours, minutes] = time.split(':');
    if (hours === '12') {
      hours = '00';
    }
    if (modifier === 'PM') {
      hours = parseInt(hours, 10) + 12;
    }
    return `${hours}:${minutes}`;
  }

  async function showUpcomingAppointmentPopup() {
    const popup = document.getElementById('upcomingAppointmentPopup');
    
    if (!upcomingAppointment) {
      upcomingAppointment = await loadUpcomingAppointment();
    }

    if (upcomingAppointment) {
      document.getElementById('upcomingAppointmentContent').innerHTML = `
        <p><strong>Client:</strong> ${upcomingAppointment.client_name}</p>
        <p><strong>Date:</strong> ${upcomingAppointment.appointment_date}</p>
        <p><strong>Time:</strong> ${upcomingAppointment.appointment_time}</p>
      `;
      
      document.getElementById('viewAppointmentBtn').onclick = () => {
        openAppointmentDetails(upcomingAppointment);
        popup.classList.remove('show');
      };
      
      setTimeout(() => {
        popup.classList.add('show');
      }, 2000);
      
      setTimeout(() => {
        popup.classList.remove('show');
      }, 10000);
    } else {
      document.getElementById('upcomingAppointmentContent').innerHTML = `
        <p class="text-center text-muted">No upcoming appointments</p>
      `;
      document.getElementById('viewAppointmentBtn').style.display = 'none';
    }
  }

  function openAppointmentDetails(appt) {
    rescheduleData = {
      email: appt.client_email,
      id: appt.appt_id,
      current: appt
    };

    const hasReschedule = !!appt.reschedule_request;
    const isClientReschedule = hasReschedule && appt.reschedule_request.status.includes('client');
    
    let statusBadge = '';
    if (hasReschedule) {
      const requester = isClientReschedule ? 'Client' : 'You';
      statusBadge = `<span class="status-badge reschedule"><i class="fas fa-clock me-1"></i>Reschedule Requested (${requester})</span>`;
    } else if (appt.status === 'confirmed') {
      statusBadge = `<span class="status-badge confirmed"><i class="fas fa-check-circle me-1"></i>Confirmed</span>`;
    } else {
      statusBadge = `<span class="status-badge pending"><i class="fas fa-hourglass-half me-1"></i>Pending</span>`;
    }

    document.getElementById("infoModalBody").innerHTML = `
      <p><strong>Client:</strong> ${appt.client_name}</p>
      <p><strong>Date:</strong> ${appt.appointment_date}</p>
      <p><strong>Time:</strong> ${appt.appointment_time}</p>
      <p><strong>Case Details:</strong> ${appt.case_details}</p>
      <p><strong>Status:</strong> ${statusBadge}</p>
      ${hasReschedule ? `
        <hr>
        <p class="text-primary"><strong><i class="fas fa-clock me-2"></i>Reschedule Request:</strong></p>
        <p><strong>Requested By:</strong> ${isClientReschedule ? 'Client' : 'You'}</p>
        <p><strong>Current Date:</strong> ${appt.appointment_date}</p>
        <p><strong>Current Time:</strong> ${appt.appointment_time}</p>
        <p><strong>Proposed Date:</strong> ${appt.reschedule_request.new_date}</p>
        <p><strong>Proposed Time:</strong> ${appt.reschedule_request.new_time}</p>
        <p><strong>Status:</strong> <span class="status-badge pending">${appt.reschedule_request.status}</span></p>
      ` : ''}
    `;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const appointmentDate = new Date(appt.appointment_date);
    const isExpired = appointmentDate < today;
    
    const footer = document.getElementById("modalFooterButtons");
    footer.innerHTML = `
      <button class="btn btn-success" id="confirmBtn" ${isExpired ? "disabled" : ""}>
        <i class="fas fa-check-circle me-2"></i>Confirm
      </button>
      <button class="btn btn-danger" id="deleteBtn" ${isExpired ? "disabled" : ""}>
        <i class="fas fa-trash-alt me-2"></i>Delete
      </button>
      <button class="btn btn-warning" id="rescheduleBtn" ${isExpired ? "disabled" : ""}>
        <i class="fas fa-calendar-alt me-2"></i>Reschedule
      </button>
      ${hasReschedule ? `
        ${isClientReschedule ? `
          <button class="btn btn-success" id="approveRescheduleBtn">
            <i class="fas fa-check me-2"></i>Approve
          </button>
          <button class="btn btn-outline" id="declineRescheduleBtn">
            <i class="fas fa-times me-2"></i>Decline
          </button>
        ` : `
          <button class="btn btn-outline" id="cancelRescheduleBtn">
            <i class="fas fa-times me-2"></i>Cancel Request
          </button>
        `}
      ` : ''}
    `;
    
    const infoModal = new bootstrap.Modal(document.getElementById("infoModal"));
    infoModal.show();

    document.getElementById("confirmBtn").onclick = async () => {
        try {
            const updates = {
                [`bookings/${rescheduleData.email}/${rescheduleData.id}/status`]: "confirmed"
            };
            await update(ref(db), updates);
            alert("Appointment confirmed.");
            infoModal.hide();
            loadAppointments(lawyerName);
        } catch (error) {
            console.error("Error confirming appointment:", error);
            alert("Failed to confirm appointment. Please try again.");
        }
    };

    document.getElementById("deleteBtn").onclick = async () => {
        if (confirm("Are you sure you want to delete this appointment?")) {
            try {
                await update(ref(db, `bookings/${rescheduleData.email}/${rescheduleData.id}`), null);
                alert("Appointment deleted.");
                infoModal.hide();
                loadAppointments(lawyerName);
            } catch (error) {
                console.error("Error deleting appointment:", error);
                alert("Failed to delete appointment. Please try again.");
            }
        }
    };
    
    document.getElementById("rescheduleBtn").onclick = () => {
      infoModal.hide();
      showRescheduleModal();
    };
    
    if (hasReschedule) {
      if (isClientReschedule) {
        document.getElementById("approveRescheduleBtn").onclick = async () => {
            try {
                const updates = {
                    [`bookings/${rescheduleData.email}/${rescheduleData.id}/appointment_date`]: 
                        rescheduleData.current.reschedule_request.new_date,
                    [`bookings/${rescheduleData.email}/${rescheduleData.id}/appointment_time`]: 
                        rescheduleData.current.reschedule_request.new_time,
                    [`bookings/${rescheduleData.email}/${rescheduleData.id}/status`]: "confirmed",
                    [`bookings/${rescheduleData.email}/${rescheduleData.id}/reschedule_request`]: null
                };
                await update(ref(db), updates);
                alert("Reschedule approved. Appointment updated.");
                infoModal.hide();
                loadAppointments(lawyerName);
            } catch (error) {
                console.error("Error approving reschedule:", error);
                alert("Failed to approve reschedule. Please try again.");
            }
        };

        document.getElementById("declineRescheduleBtn").onclick = async () => {
            try {
                const updates = {
                    [`bookings/${rescheduleData.email}/${rescheduleData.id}/status`]: "confirmed",
                    [`bookings/${rescheduleData.email}/${rescheduleData.id}/reschedule_request`]: null
                };
                await update(ref(db), updates);
                alert("Reschedule declined. Original appointment kept.");
                infoModal.hide();
                loadAppointments(lawyerName);
            } catch (error) {
                console.error("Error declining reschedule:", error);
                alert("Failed to decline reschedule. Please try again.");
            }
        };
      } else {
        document.getElementById("cancelRescheduleBtn").onclick = async () => {
          try {
            await update(ref(db, `bookings/${rescheduleData.email}/${rescheduleData.id}/reschedule_request`), null);
            alert("Reschedule request cancelled.");
            infoModal.hide();
            loadAppointments(lawyerName);
          } catch (error) {
            console.error("Error cancelling reschedule:", error);
            alert("Failed to cancel reschedule request. Please try again.");
          }
        };
      }
    }
  }

  async function loadAppointments(lawyerName) {
    const container = document.getElementById('appointments-container');
    container.innerHTML = '';

    const snapshot = await get(ref(db, 'bookings'));
    if (!snapshot.exists()) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-calendar-xmark"></i>
          <div class="text-muted">No appointments found</div>
        </div>`;
      return;
    }

    function getDayOfWeek(dateString) {
      const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      const date = new Date(dateString);
      return days[date.getDay()];
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const allBookings = snapshot.val();
    let found = false;

    allAppointments = [];

    for (const client in allBookings) {
      for (const id in allBookings[client]) {
        const appt = allBookings[client][id];
        if ((appt.lawyer_name || '').toLowerCase() === lawyerName.toLowerCase()) {
          allAppointments.push({ ...appt, client_email: client, appt_id: id });
        }
      }
    }
    
    allAppointments.sort((a, b) => {
      if (currentSort === "az") {
        return (a.client_name || '').localeCompare(b.client_name || '');
      } else if (currentSort === "za") {
        return (b.client_name || '').localeCompare(a.client_name || '');
      } else if (currentSort === "newest") {
        return new Date(b.appointment_date) - new Date(a.appointment_date);
      } else if (currentSort === "oldest") {
        return new Date(a.appointment_date) - new Date(b.appointment_date);
      }
      return 0;
    });
    

    for (const apptData of allAppointments) {
      const { client_email: client, appt_id: id, ...appt } = apptData;
      found = true;

      const appointmentDate = new Date(appt.appointment_date);
      appointmentDate.setHours(0, 0, 0, 0);
      const isExpired = appointmentDate < today;

      const card = document.createElement("div");
      card.className = "appointment-card glass-card" + (isExpired ? " expired" : "");
      
      let statusBadge = '';
      if (appt.reschedule_request) {
        const requester = appt.reschedule_request.status.includes('client') ? 'Client' : 'You';
        statusBadge = `<span class="status-badge reschedule"><i class="fas fa-clock me-1"></i>Reschedule Requested (${requester})</span>`;
      } else if (appt.status === 'confirmed') {
        statusBadge = `<span class="status-badge confirmed"><i class="fas fa-check-circle me-1"></i>Confirmed</span>`;
      } else {
        statusBadge = `<span class="status-badge pending"><i class="fas fa-hourglass-half me-1"></i>Pending</span>`;
      }

      card.innerHTML = `
        <div class="card-content">
          <div class="card-header">
            <strong>${appt.client_name}</strong>
          </div>
          <div class="card-body">
            <p><strong>Time:</strong> ${appt.appointment_time}</p>
            <p><strong>Date:</strong> ${appt.appointment_date} (${getDayOfWeek(appt.appointment_date)})</p>
            <p><strong>Status:</strong> ${statusBadge}</p>
          </div>
        </div>
      `;

      const index = allAppointments.findIndex(a => a.appt_id === id);
      card.style.animationDelay = `${index * 0.1}s`;

      card.addEventListener("click", () => {
        openAppointmentDetails(apptData);
      });

      container.appendChild(card);
    }

    if (!found) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-calendar-xmark"></i>
          <div class="text-muted">No appointments found for you</div>
        </div>`;
    }

    showUpcomingAppointmentPopup();
  }

  function showRescheduleModal() {
    const rescheduleModalHTML = `
      <div class="modal fade" id="rescheduleTimeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fas fa-calendar-day me-3"></i>Reschedule Appointment</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-4">
                <label for="rescheduleDate" class="form-label">New Date</label>
                <input type="date" class="form-control" id="rescheduleDate" value="${rescheduleData.current.appointment_date}" min="${new Date().toISOString().split('T')[0]}">
              </div>
              <div class="mb-4">
                <label for="rescheduleTime" class="form-label">New Time</label>
                <select class="form-select" id="rescheduleTime">
                  ${availableTimeSlots.map(slot => 
                    `<option value="${slot}" ${slot === rescheduleData.current.appointment_time ? 'selected' : ''}>${slot}</option>`
                  ).join('')}
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-warning" id="confirmReschedule">
                <i class="fas fa-paper-plane me-2"></i>Request Reschedule
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', rescheduleModalHTML);
    const modal = new bootstrap.Modal(document.getElementById('rescheduleTimeModal'));
    modal.show();
    
    document.getElementById('confirmReschedule').onclick = async () => {
      const newDate = document.getElementById('rescheduleDate').value;
      const newTime = document.getElementById('rescheduleTime').value;
      
      if (!newDate) {
        alert('Please select a date');
        return;
      }
      
      const selectedDate = new Date(newDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      if (selectedDate < today) {
        alert('Please select a future date');
        return;
      }
      
      try {
        const updates = {
          [`bookings/${rescheduleData.email}/${rescheduleData.id}/reschedule_request`]: {
            new_date: newDate,
            new_time: newTime,
            status: "pending_client_confirmation"
          }
        };
        await update(ref(db), updates);
        alert("Reschedule request sent. Awaiting client confirmation.");
        modal.hide();
        loadAppointments(lawyerName);
      } catch (error) {
        console.error("Error requesting reschedule:", error);
        alert("Failed to request reschedule. Please try again.");
      }
    };
    
    document.getElementById('rescheduleTimeModal').addEventListener('hidden.bs.modal', () => {
      document.getElementById('rescheduleTimeModal').remove();
    });
  }

  document.getElementById('quickActionBtn').addEventListener('click', async () => {
    const popup = document.getElementById('upcomingAppointmentPopup');
    
    if (!upcomingAppointment) {
      upcomingAppointment = await loadUpcomingAppointment();
    }

    if (upcomingAppointment) {
      popup.classList.toggle('show');
    }
  });

  function getStatusBadge(status) {
    const statusMap = {
      'confirmed': { class: 'success', icon: 'bi-check-circle', text: 'Confirmed' },
      'pending': { class: 'secondary', icon: 'bi-hourglass', text: 'Pending' },
      'scheduled': { class: 'info', icon: 'bi-calendar-check', text: 'Scheduled' },
      'reschedule_requested': { class: 'warning', icon: 'bi-clock-history', text: 'Reschedule Requested' },
      'delete_requested': { class: 'danger', icon: 'bi-exclamation-triangle', text: 'Delete Requested' },
      'cancelled': { class: 'dark', icon: 'bi-x-circle', text: 'Cancelled' }
    };
    
    const statusInfo = statusMap[status?.toLowerCase()] || statusMap.pending;
    
    return `<span class="badge bg-${statusInfo.class}">
      <i class="bi ${statusInfo.icon} me-1"></i>
      ${statusInfo.text}
    </span>`;
  }

  document.addEventListener('click', (e) => {
    const popup = document.getElementById('upcomingAppointmentPopup');
    const fab = document.getElementById('quickActionBtn');
    
    if (!popup.contains(e.target) && e.target !== fab && !fab.contains(e.target)) {
      popup.classList.remove('show');
    }
  });

  window.setSortOption = setSortOption;
  loadAppointments(lawyerName);
</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>